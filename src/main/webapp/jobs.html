<!DOCTYPE html>
<html>
<head>
	<title>애플리케이션</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
</head>
<body>
	<div class="container">
		<div class="row mb-3">
			<div class="col-12">
				<h1>직종관리 <button class="btn btn-primary btn-sm" id="btn-open-form"> 신규 직종 추가</button></h1>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-4">
				<div class="card">
					<div class="card-header">직종 목록</div>
					<div class="card-body">
						<div class="list-group overflow-y-auto" style="height: 600px;" id="job-list-group">
						<!-- 
							<a href="" class="list-group-item list-group-item-action active" >항목1</a>
							<a href="" class="list-group-item list-group-item-action">항목2</a>
							<a href="" class="list-group-item list-group-item-action">항목3</a>
						 -->
						</div>
					</div>
				</div>
			</div>
			<div class="col-8">
				<div class="card" id="card-job-form">
					<div class="card-header">직종정보 폼</div>
					<div class="card-body">
						<form id="form-job" class="border bg-light p-3">
							<div class="form-group mb-3">
								<label class="form-label">아이디</label>
								<input type="text" class="form-control" name="id" />
							</div>
							<div class="form-group mb-3">
								<label class="form-label">제목</label>
								<input type="text" class="form-control" name="title" />
							</div>
							<div class="form-group mb-3">
								<label class="form-label">최소급여</label>
								<input type="text" class="form-control" name="minSalary" />
							</div>
							<div class="form-group mb-3">
								<label class="form-label">최대급여</label>
								<input type="text" class="form-control" name="maxSalary" />
							</div>
							<div class="text-end">
								<button type="submit" class="btn btn-primary">등록</button>
							</div>
						</form>
					</div>
				</div>
				
				<div class="card" id="card-job-info">
					<div class="card-header">직종정보 상세</div>
					<div class="card-body">
						<table class="table">
							<tbody>
								<tr>
									<th style="width: 20%;">직종 아이디</th>
									<td style="width: 80%;" id="job-id-cell"></td>
								</tr>
								<tr>
									<th>직종 제목</th>
									<td id="job-title-cell"></td>
								</tr>
								<tr>
									<th>최소급여</th>
									<td id="job-min-salary-cell"></td>
								</tr>
								<tr>
									<th>최대급여</th>
									<td id="job-max-salary-cell"></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
<script type="text/javascript">
$(function() {
	// 숨기기
	// 웹페이지가 준비되면 신규 직종정보 등록폼을 숨긴다.
	$("#card-job-form").hide();
	
	// 신규 직종정보 추가 버튼을 클릭하면 신규 직종정보 등록폼을 표시하고, 직종정보 상세는 숨긴다.
	$("#btn-open-form").click(function() {
		$("#card-job-info").hide();
		$("#card-job-form").show();
	});
	
	// 웹페이지의 HTML DOM객체가 준비되면 REST API를 제공하는 서버에 직종목록을 요청한다. 
	$.getJSON('http://localhost:81/jobs', function(jobs) {
		//console.log(jobs);
		/*
			jobs에는 서버가 응답으로 보낸 json텍스트를 자바스크립트 배열 혹은 객체로 변환된 것이 전달된다.
			
			jobs -> [{id:xxxx, title:xxx, minSalary:xxx, maxSalary:xxx}, {}, {}]
		*/
		// 배열객체.forEach(함수)는 지정된 함수를 배열의 데이터 갯수만큼 실행한다.
		//					  지정된 함수를 실행할 때 마다 배열의 0번째, 1번째, 2번째, ... 데이터가 
		//					  함수의 매개변수로 전달된다.
		
		// jQuery 결과집합
		// 부서항목을 추가할 div엘리먼트를 선택한다.
		// $jobListGroup 변수에는 선택된 div 엘리먼트가 포함된 JQuery집합객체가 대입된다.
		let $jobListGroup = $('#job-list-group');
		
		// 배열의 forEach()메소드를 실행해서 jobs배열의 데이터를 반복처리한다.
		jobs.forEach(function(job, index) {
			//console.log(job);
			// 리스트그룹에 추가할 list-group-item html 컨텐츠를 생성한다.
			// 클릭할때마다 ajax 요청 (event)
			let content = `
				<a href="" data-job-id="${job.id}"
					class="list-group-item list-group-item-action">${job.id}</a>
			`;
			
			// jQuery집합객체의 append()메소드를 실행해서 생성된 list-group-item 컨텐츠를 div에 추가한다.
			$jobListGroup.append(content);
		});
	});
	
	// 웹 페이지 로딩시 새로 추가된(미래) list-group-item 항목을 클릭했을 때 실행할 이벤트핸들러 함수 등록하기(페이지 로딩시 가져오기)
	// 항상 이벤트 등록하기(선택 -> 처리 -> 반영)
	$("#job-list-group").on('click', ".list-group-item", function(event) {
		event.preventDefault();
		
		$("#card-job-info").show();
		$("#card-job-form").hide();
		
		//alert("실행");
		//하이라이트 .addClass('active')
		//나빼고 나머지(나의 형제들).siblings().removeClass('active')
		//$(this) $메소드 실행 -> 반환값
		$(this)							// 반환값은 this가 포함되어 있는 jQuery집합객체다.
			   .addClass('active')		// 반환값은 this가 포함되어 있는 jQuery집합객체다.
			   .siblings()				// 반환값은 this를 제외한 this의 형제 엘리먼트가 포함되어 있는 jQuery집합객체다.
			   .removeClass('active');	
		
		
		// this는 클릭한 직종 엘리먼트다.
		// $(this)는 클릭한 에리먼트가 포함된 JQuery집합객체다.
		// $(this).attr("속성명") : 속성명에 해당하는 속성값을 변환한다.
		let jobId = $(this).attr("data-job-id");
		//alert(jobId);
		
		$.getJSON(`http://localhost:81/jobs/${jobId}`, function(job) {
			//console.log(job);
			// job -> {id:xxxx, title:xxx, minSalary:xxx, maxSalary:xxx}
			$("#job-id-cell").text(job.id);
			$("#job-title-cell").text(job.title);
			$("#job-min-salary-cell").text(job.minSalary);
			$("#job-max-salary-cell").text(job.maxSalary);
		})
	})
	
	
	// 직종정보 등록폼에서 submit 이벤트 발생시 실행되는 이벤트핸들러 함수 구현하고 등록하기
	$("#form-job").submit(function(event) {
		event.preventDefault();	//폼 입력값을 서버로 직접 제출하지 않고, ajax실행할 것이기 때문에 
		
		// 폼 입력요소의 입력값을 읽어온다.
		let idValue = $(":input[name=id]").val();
		let titleValue = $(":input[name=title]").val();
		let minSalaryValue = $(":input[name=minSalary]").val();
		let maxSalaryValue = $(":input[name=maxSalary]").val();
		
		if (idValue === "") {
			alert("직종아이디를 입력하세요.");
			return false;
		}
		if (titleValue === "") {
			alert("직종제를 입력하세요.");
			return false;
		}
		if (minSalaryValue === "") {
			alert("최소급여를 입력하세요.");
			return false;
		}
		if (maxSalaryValue === "") {
			alert("최대급여를 입력하세요.");
			return false;
		}
		
		// 입력필드의 입력값을 조회해서 자바스크립트 객체를 생성함
		let obj = {
			id: idValue, 
			title: titleValue,
			minSalary: minSalaryValue,
			maxSalary: maxSalaryValue
		}
		
		// 자바스크립트객체를 json 형식의 텍스트로 변환하기
		let jsonText = JSON.stringify(obj);
		
		$.ajax({
			type: "POST",						// 요청방식
			url: "http://localhost:81/jobs",	// 요청URL
			contentType: 'application/json',	// 요청데이터의 형식 컨텐츠타입
			data: jsonText,						// 요청데이터
			dataType: 'json',					// 응답데이터의 타입
			success: function(job) {			// 요청처리 성공시 실행하는 함수
				//console.log(job)
				alert("신규 직종 등록이 완료되었습니다.");
				// 응답으로 전달받은 직종정보로 리스트그룹의 새 항목을 생성한다.
				let content = `
					<a href="" data-job-id="${job.id}"
						class="list-group-item list-group-item-action">${job.id}</a>
				`;
				
				// 리스트그룹 div에 새 항목을 추가한다.
				$('#job-list-group').append(content);
			},
			error: function() {					// 요청처리 실패시 실행하는 함수
				//console.log()
				alert("신규 직종 등록 중 오류가 발생하였습니다.");
			}
		});
	});
	
	function clearField() {
		$(":input[name=id]").val('')
		$(":input[name=title]").val('')
		$(":input[name=minSalary]").val('')
		$(":input[name=maxSalary]").val('')
	}
})
</script>
</body>
</html>